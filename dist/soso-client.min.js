/**
 * SoSo v3.2.0
 * (c) 2016 Ruslan Ianberdin
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Soso=t()}(this,function(){"use strict";function e(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return o[255&e]+o[e>>8&255]+o[e>>16&255]+o[e>>24&255]+"-"+o[255&t]+o[t>>8&255]+"-"+o[t>>16&15|64]+o[t>>24&255]+"-"+o[63&n|128]+o[n>>8&255]+"-"+o[n>>16&255]+o[n>>24&255]+o[255&s]+o[s>>8&255]+o[s>>16&255]+o[s>>24&255]}var t=function(e,t){this.url=e,this.log=!0,this.logData=!0,this.onmessage=null,this.onopen=null,this.ondirectmsg=null,this.onclose=null,this.onerror=null,this.middleware=new s(this),this.sock=null,this.callbacks={},this.routes=[],this.connected=!1,this.cache={requests:[]},t||this.init()};t.prototype.init=function(){var e=this;this.sock=new WebSocket(this.url),this.sock.onmessage=function(t){var o=JSON.parse(t.data);if(e.middleware.beforeReceiveExecute(o),e.onmessage&&e.onmessage(o),o.other.trans_id)e.callbacks[o.other.trans_id](o),delete e.callbacks[o.other.trans_id];else{e.ondirectmsg&&e.ondirectmsg(o);for(var n=0;n<e.routes.length;n++){var s=e.routes[n];o.model===s.model&&o.action==s.action&&s.func(o)}}if(e.log){var i="";o.other.sent_at&&(i=(new Date).getTime()-o.other.sent_at+"ms"),console.log("[CHAN] <-- "+o.model,o.action,o.log.code_str,o.log.user_msg,o.log.level_str,i,e.logData?o:"")}},this.sock.onopen=function(t){1!==e.sock.readyState?e.connected=!1:(e.connected=!0,e._resendOfflineRequests()),e.onopen&&e.onopen(t)},this.sock.onclose=function(t){e.connected=!1,setTimeout(function(){e.log&&console.log("[SOSO] trying recconecting"),e.init()},1e3),e.onclose&&e.onclose(t)},this.sock.onerror=function(t){e.onerror&&e.onerror(t)}},t.prototype.handle=function(e,t,o){this.routes.push({model:e,action:t,func:o})},t.prototype.get=function(e,t,o,n){return this.request(e,"get",t,o,n)},t.prototype.search=function(e,t,o,n){return this.request(e,"search",t,o,n)},t.prototype.create=function(e,t,o,n){return this.request(e,"create",t,o,n)},t.prototype.update=function(e,t,o,n){return this.request(e,"update",t,o,n)},t.prototype.delete=function(e,t,o,n){return this.request(e,"delete",t,o,n)},t.prototype.flush=function(e,t,o,n){return this.request(e,"flush",t,o,n)},t.prototype.request=function(t,o,n,s,i){var r=this;return void 0===n&&(n={}),void 0===s&&(s={}),void 0===i&&(i={}),new Promise(function(c){s.sent_at=(new Date).getTime(),s.trans_id=e(),r.callbacks[s.trans_id]=c,r._send({model:t,action:o,data:n,log:i,other:s})})},t.prototype.send=function(e,t,o,n,s){void 0===o&&(o={}),void 0===n&&(n={}),void 0===s&&(s={}),this._send({model:e,action:t,data:o,log:s,other:n})},t.prototype._send=function(e){this.connected?(this.middleware.beforeSendExecute(e),this.sock.send(JSON.stringify(e)),this.log&&console.log("[CHAN] -->",e.model,e.action,this.logData?e:"")):this.cache.requests.find(function(t){return t.action===e.action&&t.model===e.model&&JSON.stringify(t.data)===JSON.stringify(e.data)})||this.cache.requests.push(e)},t.prototype._resendOfflineRequests=function(){var e=this;if(this.connected)for(;this.cache.requests.length>0;)e._send(e.cache.requests.pop())};for(var o=[],n=0;n<256;n++)o[n]=(n<16?"0":"")+n.toString(16);var s=function(e){this.client=e,this.beforeSendList=[],this.beforeReceiveList=[]};return s.prototype.beforeSend=function(e){this.beforeSendList.push(e)},s.prototype.beforeReceive=function(e){this.beforeReceiveList.push(e)},s.prototype.beforeSendExecute=function(e){this.beforeSendList.forEach(function(t){t(e)})},s.prototype.beforeReceiveExecute=function(e){this.beforeReceiveList.forEach(function(t){t(e)})},t});