/**
 * SoSo v3.0.3
 * (c) 2016 Ruslan Ianberdin
 * @license MIT
 */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):e.Soso=o()}(this,function(){"use strict";function e(e){var o=this;this.url=e,this.log=!0,this.sock=new f(e),this.onmessage=null,this.onopen=null,this.ondirectmsg=null,this.onclose=null,this.onerror=null,this.callbacks={},this.routes=[],this.sock.onmessage=function(e){var t=JSON.parse(e.data);if(o.onmessage&&o.onmessage(t),t.other.trans_id)o.callbacks[t.other.trans_id](t),delete o.callbacks[t.other.trans_id];else{o.ondirectmsg&&o.ondirectmsg(t);for(var r=0;r<o.routes.length;r++){var i=o.routes[r];t.model===i.mode&&t.action==i.action&&i.func(t)}}if(o.log){var c="";t.other.sent_at&&(c=(new Date).getTime()-t.other.sent_at+"ms");var s=n(e.data)/1024;console.log("[CHAN] <- "+t.model,t.action,t.log.code_str,t.log.user_msg,t.log.level_str,c,+s.toFixed(3)+"kb")}},this.sock.onopen=function(e){o.onopen&&o.onopen(e)},this.sock.onclose=function(e){o.onclose&&o.onclose(e)},this.sock.onerror=function(e){o.onerror&&o.onerror(e)}}function o(){var e=4294967295*Math.random()|0,o=4294967295*Math.random()|0,n=4294967295*Math.random()|0,t=4294967295*Math.random()|0;return v[255&e]+v[e>>8&255]+v[e>>16&255]+v[e>>24&255]+"-"+v[255&o]+v[o>>8&255]+"-"+v[o>>16&15|64]+v[o>>24&255]+"-"+v[63&n|128]+v[n>>8&255]+"-"+v[n>>16&255]+v[n>>24&255]+v[255&t]+v[t>>8&255]+v[t>>16&255]+v[t>>24&255]}function n(e){return e.split("").map(function(e){return e.charCodeAt(0)}).map(function(e){return e<128?1:2}).reduce(function(e,o){return e+o})}var t=function(e){return e&&2===e.CLOSING},r=function(){return"undefined"!=typeof WebSocket&&t(WebSocket)},i=function(){return{constructor:r()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}},c=function(e,o,n){Object.defineProperty(o,n,{get:function(){return e[n]},set:function(o){e[n]=o},enumerable:!0,configurable:!0})},s=function(e){return e.minReconnectionDelay+Math.random()*e.minReconnectionDelay},a=function(e,o){var n=o*e.reconnectionDelayGrowFactor;return n>e.maxReconnectionDelay?e.maxReconnectionDelay:n},u=["onopen","onclose","onmessage","onerror"],l=function(e,o,n){Object.keys(n).forEach(function(o){n[o].forEach(function(n){var t=n[0],r=n[1];e.addEventListener(o,t,r)})}),o&&u.forEach(function(n){e[n]=o[n]})},d=function(e,o,n){var r=this;void 0===n&&(n={});var u,f,v=0,m=0,h=!0,p=null,y={};if(!(this instanceof d))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var g=i();if(Object.keys(g).filter(function(e){return n.hasOwnProperty(e)}).forEach(function(e){return g[e]=n[e]}),!t(g.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var E=g.debug?function(){for(var e=arguments,o=[],n=0;n<arguments.length;n++)o[n-0]=e[n];return console.log.apply(console,["RWS:"].concat(o))}:function(){},k=function(e,o){return setTimeout(function(){var n=new Error(o);n.code=e,Array.isArray(y.error)&&y.error.forEach(function(e){var o=e[0];return o(n)}),u.onerror&&u.onerror(n)},0)},b=function(){return E("close"),m++,E("retries count:",m),m>g.maxRetries?void k("EHOSTDOWN","Too many failed connection attempts"):(v=v?a(g,v):s(g),E("reconnectDelay:",v),void(h&&setTimeout(w,v)))},w=function(){E("connect");var n=u;u=new g.constructor(e,o),f=setTimeout(function(){E("timeout"),u.close(),k("ETIMEDOUT","Connection timeout")},g.connectionTimeout),E("bypass properties");for(var t in u)["addEventListener","removeEventListener","close","send"].indexOf(t)<0&&c(u,r,t);u.addEventListener("open",function(){clearTimeout(f),E("open"),v=s(g),E("reconnectDelay:",v),m=0}),u.addEventListener("close",b),l(u,n,y),u.onclose=u.onclose||p,p=null};E("init"),w(),this.close=function(e,o,n){void 0===e&&(e=1e3),void 0===o&&(o="");var t=void 0===n?{}:n,r=t.keepClosed,i=void 0!==r&&r,c=t.fastClose,s=void 0===c||c,a=t.delay,l=void 0===a?0:a;if(l&&(v=l),h=!i,u.close(e,o),s){var d={code:e,reason:o,wasClean:!0};b(),u.removeEventListener("close",b),Array.isArray(y.close)&&y.close.forEach(function(e){var o=e[0],n=e[1];o(d),u.removeEventListener("close",o,n)}),u.onclose&&(p=u.onclose,u.onclose(d),u.onclose=null)}},this.send=function(e){u.send(e)},this.addEventListener=function(e,o,n){Array.isArray(y[e])?y[e].some(function(e){var n=e[0];return n===o})||y[e].push([o,n]):y[e]=[[o,n]],u.addEventListener(e,o,n)},this.removeEventListener=function(e,o,n){Array.isArray(y[e])&&(y[e]=y[e].filter(function(e){var n=e[0];return n!==o})),u.removeEventListener(e,o,n)}},f=d;e.prototype.handle=function(e,o,n){this.routes.push({model:e,action:o,func:n})},e.prototype.request=function(e,t,r,i,c){var s=this;return void 0===r&&(r={}),void 0===i&&(i={}),void 0===c&&(c={}),new Promise(function(a){i.sent_at=(new Date).getTime(),i.trans_id=o(),s.callbacks[i.trans_id]=a;var u=JSON.stringify({model:e,action:t,data:r,log:c,other:i});if(s.sock.send(u),s.log){var l=n(u)/1024;console.log("[CHAN] ?-> "+e,t,+l.toFixed(3)+"kb")}})},e.prototype.send=function(e,o,t,r,i){void 0===t&&(t={}),void 0===r&&(r={}),void 0===i&&(i={});var c=JSON.stringify({model:model,action:o,data:t,log:i,other:r});if(this.sock.send(c),this.log){var s=n(c)/1024;console.log("[CHAN] -> "+model,o,+s.toFixed(3)+"kb")}};for(var v=[],m=0;m<256;m++)v[m]=(m<16?"0":"")+m.toString(16);return e});