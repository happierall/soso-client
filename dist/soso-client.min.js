/**
 * SoSo v1.0.4
 * (c) 2016 Ruslan Ianberdin
 * @license MIT
 */
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.Soso=e()}(this,function(){"use strict";function n(n){var e=this;this.url=n,this.log=!0,this.sock=new d(n),this.onmessage=null,this.onopen=null,this.ondirectmsg=null,this.onclose=null,this.onerror=null,this.callbacks={},this.routes=[],this.sock.onmessage=function(n){var t=JSON.parse(n.data);if(e.onmessage&&e.onmessage(t),t.trans_map.trans_id)e.callbacks[t.trans_map.trans_id](t),delete e.callbacks[t.trans_map.trans_id];else{e.ondirectmsg&&e.ondirectmsg(t);for(var r=0;r<e.routes.length;r++){var i=e.routes[r];t.data_type===i.data_type&&t.action_str==i.action_str&&i.func(t)}}if(e.log){var s="";t.trans_map.sent_at&&(s=(new Date).getTime()-t.trans_map.sent_at+"ms");var c=o(n.data)/1024;console.log("[CHAN] <- "+t.data_type,t.action_str,t.log_map.code_str,t.log_map.user_msg,t.log_map.level_str,s,+c.toFixed(3)+"kb")}},this.sock.onopen=function(n){e.onopen&&e.onopen(n)},this.sock.onclose=function(n){e.onclose&&e.onclose(n)},this.sock.onerror=function(n){e.onerror&&e.onerror(n)}}function e(){var n=4294967295*Math.random()|0,e=4294967295*Math.random()|0,o=4294967295*Math.random()|0,t=4294967295*Math.random()|0;return v[255&n]+v[n>>8&255]+v[n>>16&255]+v[n>>24&255]+"-"+v[255&e]+v[e>>8&255]+"-"+v[e>>16&15|64]+v[e>>24&255]+"-"+v[63&o|128]+v[o>>8&255]+"-"+v[o>>16&255]+v[o>>24&255]+v[255&t]+v[t>>8&255]+v[t>>16&255]+v[t>>24&255]}function o(n){return n.split("").map(function(n){return n.charCodeAt(0)}).map(function(n){return n<128?1:2}).reduce(function(n,e){return n+e})}var t=function(n){return n&&2===n.CLOSING},r=function(){return"undefined"!=typeof WebSocket&&t(WebSocket)},i=function(){return{constructor:r()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}},s=function(n,e,o){Object.defineProperty(e,o,{get:function(){return n[o]},set:function(e){n[o]=e},enumerable:!0,configurable:!0})},c=function(n){return n.minReconnectionDelay+Math.random()*n.minReconnectionDelay},a=function(n,e){var o=e*n.reconnectionDelayGrowFactor;return o>n.maxReconnectionDelay?n.maxReconnectionDelay:o},u=["onopen","onclose","onmessage","onerror"],l=function(n,e,o){Object.keys(o).forEach(function(e){o[e].forEach(function(o){var t=o[0],r=o[1];n.addEventListener(e,t,r)})}),e&&u.forEach(function(o){n[o]=e[o]})},f=function(n,e,o){var r=this;void 0===o&&(o={});var u,d,v=0,m=0,p=!0,h=null,y={};if(!(this instanceof f))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var _=i();if(Object.keys(_).filter(function(n){return o.hasOwnProperty(n)}).forEach(function(n){return _[n]=o[n]}),!t(_.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var g=_.debug?function(){for(var n=arguments,e=[],o=0;o<arguments.length;o++)e[o-0]=n[o];return console.log.apply(console,["RWS:"].concat(e))}:function(){},E=function(n,e){return setTimeout(function(){var o=new Error(e);o.code=n,Array.isArray(y.error)&&y.error.forEach(function(n){var e=n[0];return e(o)}),u.onerror&&u.onerror(o)},0)},k=function(){return g("close"),m++,g("retries count:",m),m>_.maxRetries?void E("EHOSTDOWN","Too many failed connection attempts"):(v=v?a(_,v):c(_),g("reconnectDelay:",v),void(p&&setTimeout(b,v)))},b=function(){g("connect");var o=u;u=new _.constructor(n,e),d=setTimeout(function(){g("timeout"),u.close(),E("ETIMEDOUT","Connection timeout")},_.connectionTimeout),g("bypass properties");for(var t in u)["addEventListener","removeEventListener","close","send"].indexOf(t)<0&&s(u,r,t);u.addEventListener("open",function(){clearTimeout(d),g("open"),v=c(_),g("reconnectDelay:",v),m=0}),u.addEventListener("close",k),l(u,o,y),u.onclose=u.onclose||h,h=null};g("init"),b(),this.close=function(n,e,o){void 0===n&&(n=1e3),void 0===e&&(e="");var t=void 0===o?{}:o,r=t.keepClosed,i=void 0!==r&&r,s=t.fastClose,c=void 0===s||s,a=t.delay,l=void 0===a?0:a;if(l&&(v=l),p=!i,u.close(n,e),c){var f={code:n,reason:e,wasClean:!0};k(),u.removeEventListener("close",k),Array.isArray(y.close)&&y.close.forEach(function(n){var e=n[0],o=n[1];e(f),u.removeEventListener("close",e,o)}),u.onclose&&(h=u.onclose,u.onclose(f),u.onclose=null)}},this.send=function(n){u.send(n)},this.addEventListener=function(n,e,o){Array.isArray(y[n])?y[n].some(function(n){var o=n[0];return o===e})||y[n].push([e,o]):y[n]=[[e,o]],u.addEventListener(n,e,o)},this.removeEventListener=function(n,e,o){Array.isArray(y[n])&&(y[n]=y[n].filter(function(n){var o=n[0];return o!==e})),u.removeEventListener(n,e,o)}},d=f;n.prototype.handle=function(n,e,o){this.routes.push({data_type:n,action_str:e,func:o})},n.prototype.request=function(n,t,r,i,s){var c=this;return void 0===r&&(r={}),void 0===i&&(i={}),void 0===s&&(s={}),new Promise(function(a){i.sent_at=(new Date).getTime(),i.trans_id=e(),c.callbacks[i.trans_id]=a;var u=JSON.stringify({data_type:n,action_str:t,log_map:s,request_map:r,trans_map:i});if(c.sock.send(u),c.log){var l=o(u)/1024;console.log("[CHAN] ?-> "+n,t,+l.toFixed(3)+"kb")}})},n.prototype.send=function(n,e,t,r,i){void 0===t&&(t={}),void 0===r&&(r={}),void 0===i&&(i={});var s=JSON.stringify({data_type:n,action_str:e,log_map:i,request_map:t,trans_map:r});if(this.sock.send(s),this.log){var c=o(s)/1024;console.log("[CHAN] -> "+n,e,+c.toFixed(3)+"kb")}};for(var v=[],m=0;m<256;m++)v[m]=(m<16?"0":"")+m.toString(16);return n});